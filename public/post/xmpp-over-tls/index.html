<!DOCTYPE html>
<html class="no-js">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>XMPP over TLS Tutorial  &middot; Magic Broccoli</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="description" content="" />

<meta name="keywords" content="TeamSpeak Script, XEP-0368, XMPP, ">


<meta property="og:title" content="XMPP over TLS Tutorial  &middot; Magic Broccoli ">
<meta property="og:site_name" content="Magic Broccoli"/>
<meta property="og:url" content="https://magicbroccoli.de/post/xmpp-over-tls/" />
<meta property="og:locale" content="de-DE">


<meta property="og:type" content="article" />
<meta property="og:description" content=""/>
<meta property="og:article:published_time" content="2017-08-06T15:00:00&#43;02:00" />
<meta property="og:article:modified_time" content="2017-08-06T15:00:00&#43;02:00" />

  
    
<meta property="og:article:tag" content="TeamSpeak Script">
    
<meta property="og:article:tag" content="XEP-0368">
    
<meta property="og:article:tag" content="XMPP">
    
  

  
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@" />
<meta name="twitter:creator" content="@" />
<meta name="twitter:title" content="XMPP over TLS Tutorial" />
<meta name="twitter:description" content="" />
<meta name="twitter:url" content="https://magicbroccoli.de/post/xmpp-over-tls/" />
<meta name="twitter:domain" content="https://magicbroccoli.de/">
  

<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "Article",
    "headline": "XMPP over TLS Tutorial",
    "author": {
      "@type": "Person",
      "name": "http://profiles.google.com/+?rel=author"
    },
    "datePublished": "2017-08-06",
    "description": "",
    "wordCount": 705
  }
</script>



<link rel="canonical" href="https://magicbroccoli.de/post/xmpp-over-tls/" />

<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://magicbroccoli.de/touch-icon-144-precomposed.png">
<link href="https://magicbroccoli.de/favicon.ico" rel="icon">

<meta name="generator" content="Hugo 0.26" />


  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">

  <link rel="stylesheet" href="https://magicbroccoli.de/assets/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://magicbroccoli.de/assets/css/style.css">
  <link rel="stylesheet" href="https://magicbroccoli.de/assets/css/tomorrow-night.css">
  <link href='//fonts.googleapis.com/css?family=Source+Code+Pro' rel='stylesheet' type='text/css'>

</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-md navbar-light blog-header">
  <div class="container">
    <button class="navbar-toggler" type="button" data-toggle="collapse"
        data-target="#exCollapsingNavbar2"
        aria-controls="exCollapsingNavbar2" aria-expanded="false" aria-label="Toggle navigation">
      &#9776;
    </button>
    <div class="collapse navbar-collapse" id="exCollapsingNavbar2">
      <a class="navbar-brand" href="https://magicbroccoli.de/">Magic Broccoli</a>
      <ul class="nav navbar-nav">
        
        
          <li class="nav-item">
          <a class="nav-link menu-item" href="https://magicbroccoli.de/">
              <i class='fa fa-home fa-fw'></i>
              <span>Home</span>
          </a>
        </li>
        
          <li class="nav-item">
          <a class="nav-link menu-item" href="https://magicbroccoli.de/xmpp/">
              <i class='fa fa-delicious'></i>
              <span>XMPP</span>
          </a>
        </li>
        
          <li class="nav-item">
          <a class="nav-link menu-item" href="https://magicbroccoli.de/register/">
              <i class='fa fa-plus' fa-fw'></i>
              <span>Register</span>
          </a>
        </li>
        
          <li class="nav-item">
          <a class="nav-link menu-item" href="https://magicbroccoli.de/contact">
              <i class='fa fa-info-circle'></i>
              <span>About me</span>
          </a>
        </li>
        
      </ul>
    </div>
  </div>
</nav>

<div class="container p-a-0">
  <div class="row m-l-0 m-r-0">
    <div class="col-xs-12 col-md-9 post-container">
      <div>
  

  <h1 class="post-title">XMPP over TLS Tutorial
</h1>

  <div class="post-meta">
  <div class="post-meta-item">
    <i class="fa fa-calendar"></i>
    <time datetime="2017-08-06">6 Aug, 2017</time>

    
      &middot; by nico
    
    &middot; 4 Minute Read
    &middot; 705 Words
  </div>

  
      
      
      <div class="post-meta-item">
          <i class="fa fa-folder-open-o"></i>
          
          <a class="article-category-link" href="https://magicbroccoli.de/categories/xep-0368/">XEP-0368</a>
          &middot;
          
          <a class="article-category-link" href="https://magicbroccoli.de/categories/prosody/">Prosody</a>
          &middot;
          
          <a class="article-category-link" href="https://magicbroccoli.de/categories/xmpp/">XMPP</a>
          
          
      </div>
      
  

  
      
      
        <div class="post-meta-item">
          <i class="fa fa-tags"></i>
          
          <a href="https://magicbroccoli.de/tags/xmpp/">XMPP</a>
          &middot;
          
          <a href="https://magicbroccoli.de/tags/prosody/">Prosody</a>
          &middot;
          
          <a href="https://magicbroccoli.de/tags/guide/">Guide</a>
          
          
        </div>
      
  
  

</div>

</div>

      <div class="content">
  

<h2 id="how-to-setup-xep-0368">How to setup XEP-0368</h2>

<h3 id="was-ist-xep-0368">Was ist XEP-0368</h3>

<p>Bei <a href="https://xmpp.org/extensions/xep-0368.html" target="_blank">XEP-0368</a> handelt es sich um ein Verfahren von XMPP-Clients, über SRV Einträge im DNS, alternative Verbindungsmöglichkeiten zu entdecken, falls die regulären Wege blockiert sind, zb. durch Firewalls.</p>

<blockquote cite="https://xmpp.org/extensions/xep-0368.html">XMPP Core specifies the use of xmpp-client/xmpp-server SRV records as the method of discovering how to connect to an XMPP server. This XEP extends that to include new xmpps-client/xmpps-server SRV records pointing to direct TLS ports and combine priorities and weights as if they were a single SRV record similar to RFC 6186. It also provides an easy way for clients to bypass restrictive firewalls that only allow HTTPS, for servers to host multiple protocols/services on a single port, and for servers and clients to take advantage of less round trips and existing direct TLS loadbalancers.</blockquote>

<h3 id="was-wird-benötigt">Was wird benötigt?</h3>

<ul>
<li>Prosody Server</li>
<li><strong>optional</strong> gültiges SSL Zertifikat ( LetsEncrypt / oä )</li>
<li>2 IPv4 Adressen ( <strong>Hinweis beachten</strong> )</li>
<li>iptables und iptables-persistent</li>
<li>Kontrolle über eure DNS Zone</li>
</ul>

<p><span style="color:red"><em>Hinweis</em>: Notwendigkeit 2 IPv4 Adressen</span>
Es werden 2 IP Adressen benötigt wenn Ihre IP Adresse bereits auf Port 443 lauscht. Sprich eine <strong>https</strong> Website via Apache2 / nginx hostet. Da für diese Methode der Port verpflichtend benötigt wird. Ist dies nicht der Fall reicht eine IP Adresse vollkommen aus.</p>

<hr />

<h3 id="1-dns-einstellungen">1. DNS Einstellungen</h3>

<p>Den Anfang machen die DNS Einstellungen, da die Publizierung der neuen DNS Einstellungen bis zu 48 Stunden dauern kann.
Zusätzlich zu den <a href="https://prosody.im/doc/dns" target="_blank">Standard SRV Einträgen</a> wird ein weiterer <code>_xmpps-client._tcp</code> Eintrag benötigt, sowie ein A Record für die Subdomain.</p>

<p>In diesem Beispiel ist die Domain <code>example.com</code> und XMPP over TLS soll über <code>xmpps.example.com</code> erreichbar sein.</p>

<pre><code># Standard Settings
_xmpp-client._tcp.example.com. 18000 IN SRV 0 5 5222 example.com.
_xmpp-server._tcp.example.com. 18000 IN SRV 0 5 5269 example.com.

# XMPP over TLS Settings
_xmpps-client._tcp.example.com. 18000 IN SRV 10 5 xmpps.example.com.

# A record
xmpps.example.com. 18000 IN A $zweite_ip_adresse
</code></pre>

<h3 id="2-prosody-server-konfiguration">2. Prosody Server Konfiguration</h3>

<p>In der Prosody Konfiguration muss <em>legacy_ssl_ports</em> definiert werden. Damit das <code>http</code> Modul auch auf dem gewählten Port lauschen soll. <em>mod_legacyauth wird hierfür nicht benötigt.</em>
Ein Neustart des Prosody Services ist nach dem setzen dieser Einstellung <strong>erforderlich</strong>.</p>

<pre><code>-- XEP-0368: SRV records for XMPP over TLS
legacy_ssl_ports = { 5223 }
</code></pre>

<h3 id="3-ssl-zertifikat-optional">3. SSL Zertifikat ( <em>optional</em> )</h3>

<p>Hier wäre der Zeitpunkt das bestehende Zertifikat für <code>example.com</code> auf <code>xmpps.example.com</code> auszuweiten, um keinen <code>common name error</code> zu erzeugen. Dieses erweiterte Zertifikat ist dem Prosody zur Verfügung zu stellen.</p>

<p><em>Hinweis</em> : Dieser Teil ist vollkommen optional. Die <a href="https://prosody.im/doc/certificates" target="_blank">Prosody Dokumentation</a> zeigt auf, dass kein Zertifikat notwendig wäre.
<strong>IMHO</strong> Es macht das Gesamtbild einheitlicher, wenn auch diesem Endpunkt ein gültiges SSL Zertifikat präsentiert wird.</p>

<h3 id="4-iptables-regeln">4. iptables Regeln</h3>

<p>Für das Umleiten wird die PREROUTING und POSTROUTING Kette von <code>iptables</code> verwendet. Dabei werden Pakete, noch bevor sie überhaupt geroutet werden, umgeleitet.
Dafür werden 2 Regeln verwendet um einen <code>malformed xml-error</code> zu vermeiden.
Regel Nr. 1 leitet den gesamten Traffic der zweiten IP der auf Port 443 ankommt, ohne Veränderung an Port 5223 der ersten IP weiter.</p>

<p>Für die Antwort des Prosody Servers wird allerdings eine zweite Regel benötigt, die sich in der POSTROUTING Kette befindet. Diese stellt sicher das, dass Antwort Paket auch wieder über Port 443 der zweiten IP Adresse den Server verlässt und nicht mit 5223.
<em>Sollte bei der Prosody Konfiguration ein anderer Port gewählt werden als der default Port, muss dieser natürlich in den iptables Regeln ausgetauscht werden.</em></p>

<p>In diesem Beispiel ist $erste_ip, die IP auf der auch der httpd Server lauscht. $zweite_ip bezeichnet daher die zweite Adresse für XMPP over TLS.</p>

<pre><code class="language-#!/bin/bash"># PREROUTING
iptables -t nat -A PREROUTING -d $zweite_ip -p tcp --dport 443 -j DNAT --to-destination $erste_ip:5223

# POSTROUTING
iptables -t nat -A POSTROUTING -p tcp -d  $zweite_ip --dport 5223 -j SNAT --to-source $erste_ip:5223
</code></pre>

<p>Abschließend lassen sich diese Regeln mit <code>iptables-save</code> speichern, damit bei einem reboot die Regeln wieder geladen werden.</p>

<pre><code class="language-#!/bin/bash">iptables-save &gt; /etc/iptables/rules.v4
</code></pre>

<h2 id="abschluss">Abschluss</h2>

<p>Sollten alle diese Schritte erfolgreich abgeschlossen sein. Ist es sehr leicht möglich herauszufinden, ob alles so funktioniert wie es soll. Dafür lässt sich <code>curl -i</code> verwenden.</p>

<pre><code class="language-#!/bin/bash">curl -i https://xmpps.example.com
</code></pre>

<p>Als Ergebnis sollte ein <em>xml stream error</em> zu sehen sein, <strong>ohne</strong> Apache2 / nginx header. Ist außerdem keine Fehlermeldung über ein ungültiges SSL Zertifikat dabei ist das Zertifikat auch für die Subdomain gültig und funktioniert.</p>

<pre><code class="language-xml">&lt;?xml version='1.0'?&gt;
&lt;stream:stream xmlns:stream='http://etherx.jabber.org/streams' xml:lang='en' xmlns='jabber:client'&gt;
    &lt;stream:error&gt;
        &lt;not-well-formed xmlns='urn:ietf:params:xml:ns:xmpp-streams'/&gt;
    &lt;/stream:error&gt;
&lt;/stream:stream&gt;
</code></pre>

</div>

      <footer>
    
    
      
        <nav><ul class="pagination">
        
            <li class="page-item">
              <a href="https://magicbroccoli.de/post/omemo-statement/" title="Wir unterstützen Omemo " class="page-link">
                <span aria-hidden="true">&larr;</span>Previous
              </a>
            </li>
        

        
          <li class="page-item">
            <a href="https://magicbroccoli.de/post/database_failure/" title="Datenbank Zusammenbruch" class="page-link">
                Next <span aria-hidden="true">&rarr;</span>
            </a>
          </li>
        
        </ul> </nav>
      
    

  <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
    
  </div>
</footer>

    </div>
      <div class="col-xs-12 col-md-3">
        <div class="sidebar">
  

  


<div class="card card-block">
  <h4 class="card-title">CATEGORIES</h4>
  <div class="card-text">
    <div class="widget">
      <ul>
        
        <li class="category-list-item">
            <a href="https://magicbroccoli.de/categories/bash/">
                bash
            </a>
            <span class="category-list-count">1</span>
        </li>
        
        <li class="category-list-item">
            <a href="https://magicbroccoli.de/categories/debian/">
                debian
            </a>
            <span class="category-list-count">2</span>
        </li>
        
        <li class="category-list-item">
            <a href="https://magicbroccoli.de/categories/development/">
                development
            </a>
            <span class="category-list-count">1</span>
        </li>
        
        <li class="category-list-item">
            <a href="https://magicbroccoli.de/categories/gajim/">
                gajim
            </a>
            <span class="category-list-count">1</span>
        </li>
        
        <li class="category-list-item">
            <a href="https://magicbroccoli.de/categories/mariadb/">
                mariadb
            </a>
            <span class="category-list-count">1</span>
        </li>
        
        <li class="category-list-item">
            <a href="https://magicbroccoli.de/categories/omemo/">
                omemo
            </a>
            <span class="category-list-count">1</span>
        </li>
        
        <li class="category-list-item">
            <a href="https://magicbroccoli.de/categories/prosody/">
                prosody
            </a>
            <span class="category-list-count">2</span>
        </li>
        
        <li class="category-list-item">
            <a href="https://magicbroccoli.de/categories/teamspeak/">
                teamspeak
            </a>
            <span class="category-list-count">1</span>
        </li>
        
        <li class="category-list-item">
            <a href="https://magicbroccoli.de/categories/xep-0368/">
                xep-0368
            </a>
            <span class="category-list-count">1</span>
        </li>
        
        <li class="category-list-item">
            <a href="https://magicbroccoli.de/categories/xmpp/">
                xmpp
            </a>
            <span class="category-list-count">4</span>
        </li>
        
      </ul>
    </div>
  </div>
</div>




  



<div class="card card-block">
  <h4 class="card-title">TAGS</h4>
  <div class="card-text">
    <div class="widget">
      <ul>
        
          <li>
            <a href="https://magicbroccoli.de/tags/ca-bundle/">ca-bundle</a>
            <span class="category-list-count">1</span>
          </li>
        
          <li>
            <a href="https://magicbroccoli.de/tags/ccc/">ccc</a>
            <span class="category-list-count">1</span>
          </li>
        
          <li>
            <a href="https://magicbroccoli.de/tags/cert-error/">cert-error</a>
            <span class="category-list-count">1</span>
          </li>
        
          <li>
            <a href="https://magicbroccoli.de/tags/failure/">failure</a>
            <span class="category-list-count">1</span>
          </li>
        
          <li>
            <a href="https://magicbroccoli.de/tags/guide/">guide</a>
            <span class="category-list-count">1</span>
          </li>
        
          <li>
            <a href="https://magicbroccoli.de/tags/mariadb/">mariadb</a>
            <span class="category-list-count">1</span>
          </li>
        
          <li>
            <a href="https://magicbroccoli.de/tags/omemo/">omemo</a>
            <span class="category-list-count">1</span>
          </li>
        
          <li>
            <a href="https://magicbroccoli.de/tags/prosody/">prosody</a>
            <span class="category-list-count">3</span>
          </li>
        
          <li>
            <a href="https://magicbroccoli.de/tags/xmpp/">xmpp</a>
            <span class="category-list-count">3</span>
          </li>
        
      </ul>
    </div>
  </div>
</div>




  


<div class="card card-block">
  <h4 class="card-title">TAG CLOUD</h4>
  <p class="card-text">
    
        <a href="https://magicbroccoli.de/tags/ca-bundle/" class="badge badge-primary">
        ca-bundle
        </a>
    
        <a href="https://magicbroccoli.de/tags/ccc/" class="badge badge-primary">
        ccc
        </a>
    
        <a href="https://magicbroccoli.de/tags/cert-error/" class="badge badge-primary">
        cert-error
        </a>
    
        <a href="https://magicbroccoli.de/tags/failure/" class="badge badge-primary">
        failure
        </a>
    
        <a href="https://magicbroccoli.de/tags/guide/" class="badge badge-primary">
        guide
        </a>
    
        <a href="https://magicbroccoli.de/tags/mariadb/" class="badge badge-primary">
        mariadb
        </a>
    
        <a href="https://magicbroccoli.de/tags/omemo/" class="badge badge-primary">
        omemo
        </a>
    
        <a href="https://magicbroccoli.de/tags/prosody/" class="badge badge-primary">
        prosody
        </a>
    
        <a href="https://magicbroccoli.de/tags/xmpp/" class="badge badge-primary">
        xmpp
        </a>
    
  </p>
</div>




</div>

      </div>
  </div>
</div>
      <footer class="footer">
  <div class="container">
    <div class="row">
      <div class="col-xs-12 col-md-9">
        <p class="text-xs-center m-a-0 p-a-0">
          &copy; 2017 All rights reserved.
        </p>
        
        <p class="text-xs-center  m-a-0 p-a-0">
            
          <span class="p-l-1 p-r-1">
                <a href="https://magicbroccoli.de/impressum/">Impressum</a>
              </span>
              &middot; 
          <span class="p-l-1 p-r-1">
                <a href="https://magicbroccoli.de/termsofuse/">Terms of Use</a>
              </span>
              &middot; 
          <span class="p-l-1 p-r-1">
                <a href="https://magicbroccoli.de/datenschutz/">Privacy Policy</a>
              </span>
                
        </p>
        
      </div>
    </div>
  </div>
</footer>

    
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script>

<script src="https://magicbroccoli.de/assets/js/highlight.pack.js"></script>

<script>hljs.initHighlightingOnLoad();</script>



<script src="https://magicbroccoli.de/assets/js/script.js"></script>




<link rel="stylesheet" type="text/css" media="screen" href="https://cdn.conversejs.org/css/converse.min.css">
<script>
  if ( screen && screen.width > 960 ) {
  document.write('<script type="text\/javascript" src="https://cdn.conversejs.org/dist/converse.min.js"><\/script>');
  }
</script>
<script>
  converse.initialize({
  allow_chat_pending_contacts: true,
  allow_non_roster_messaging: true,
  allow_registration: false,
  bosh_service_url: 'https://magicbroccoli.de/http-bind',
  csi_waiting_time: 25,
  domain_placeholder: 'magicbroccoli.de',
  default_domain: 'magicbroccoli.de',
  message_carbons: true,
  muc_domain: 'conference.magicbroccoli.de',
  providers_link: 'https://magicbroccoli.de/xmpp',
  registration_domain: 'magicbroccoli.de',
  roster_groups: true,
  show_controlbox_by_default: true,
  show_send_button: true,
  });
</script>

  </body>
</html>

